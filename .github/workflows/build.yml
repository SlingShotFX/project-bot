name: CI
on:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'

      - name: Install Dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential ccache git libncurses5 libncurses5-dev libtiff5-dev libjpeg8-dev zlib1g-dev \
            libfreetype6-dev liblcms2-dev libwebp-dev libffi-dev libgstreamer1.0 libgstreamer-plugins-base1.0 libgstreamer-plugins-good1.0 \
            gstreamer1.0-plugins-{bad,base,good,ugly} gstreamer1.0-tools gstreamer1.0-x gstreamer1.0-alsa gstreamer1.0-gl gstreamer1.0-libav \
            gstreamer1.0-pulseaudio gstreamer1.0-qt5 gstreamer1.0-opencv python3 python3-pip python3-setuptools python3-wheel \
            openjdk-8-jdk unzip zip || { echo 'apt install failed'; exit 1; }
          pip install --upgrade cython || { echo 'pip install cython failed'; exit 1; }
          pip install --upgrade buildozer || { echo 'pip install buildozer failed'; exit 1; }

      - name: Get Date
        id: get-date
        run: echo "date=$(date -u '+%Y%m%d')" >> $GITHUB_ENV

      - name: Cache Buildozer global directory
        uses: actions/cache@v2
        with:
          path: .buildozer_global
          key: buildozer-global-${{ hashFiles('buildozer.spec') }}

      - uses: actions/cache@v2
        with:
          path: .buildozer
          key: ${{ runner.os }}-${{ env.date }}-${{ hashFiles('buildozer.spec') }}

      - name: Build with Buildozer
        run: buildozer android debug || { echo 'buildozer failed'; exit 1; }

      - name: Upload artifacts
        uses: actions/upload-artifact@v2
        with:
          name: package
          path: .buildozer/android/platform/build/dists/*/bin/*.apk
